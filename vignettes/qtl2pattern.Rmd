---
title: "R/qtl2pattern Vignette"
author: "Brian S. Yandell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{demo qtl2pattern features}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 7, fig.height = 5)
```

This vignette continues an example developed in library `qtl2ggplot` using data
from [qtl2data](https://github.com/rqtl/qtl2data) and tools found in [qtl2pattern](https://github.com/byandell/qtl2pattern).
Package `qtl2pattern` has `summary` methods for `scan1` and `scan1coef`.
Not sure these are really needed. The `R/qtl2` routine `find_peaks` takes care of some but not all of this functionality.
Sections below are

```{r}
library(qtl2pattern)
```

- Download of Diversity Outbred Example Data
- Genome Scan Using 36 Allele Pairs
- Genome Scan Using 8 Alleles
- SNP Association Mapping near Peak
- Strain Distribution Pattern (SDP) Scan

## Download of Diversity Outbred Example Data

This vignette uses the example Diversity Outbred (DO) data.
See [Recla et al. (2014)](https://www.ncbi.nlm.nih.gov/pubmed/24700285).
These mice were derived from 8 founder strains, yielding up to 36 allele pairs at any marker.
The data can be found in <https://github.com/rqtl/qtl2data> as `DOex`.
While these data span three chromosomes (`2, 3, X`), we focus here on
chromosome `2`.

```{r}
DOex <-
  qtl2::read_cross2(
    file.path(
      "https://raw.githubusercontent.com/rqtl",
      "qtl2data/master/DOex",
      "DOex.zip"))
```

Subset to chr 2.

```{r}
DOex <- subset(DOex, chr = "2")
```

## Genome Scan Using 36 Allele Pairs

Calculate 36 genotype probabilities for allele pairs by individual and marker.

```{r}
pr <- qtl2::calc_genoprob(DOex, error_prob=0.002)
```

```{r}
str(pr)
```

If you want all chromosomes, consider download from [qtl2data](https://github.com/rqtl/qtl2data).
Notice the `subset` to chr `2` to be consistent with example here.

```{r eval=FALSE}
tmpfile <- tempfile()
file <- paste0("https://raw.githubusercontent.com/rqtl/",
               "qtl2data/master/DOex/DOex_genoprobs.rds")
download.file(file, tmpfile)
pr <- readRDS(tmpfile)
unlink(tmpfile)
# Subset to chr 2.
pr <- subset(pr, chr = "2")
```

```{r}
scan_pr <- qtl2::scan1(pr, DOex$pheno)
```

```{r}
qtl2::find_peaks(scan_pr, DOex$pmap)
```


```{r}
summary(scan_pr, DOex$pmap)
```

```{r}
plot(scan_pr, DOex$pmap)
title("Genome scan of OF_immobile_pct")
```

The peak is not clear using the 36 allele pairs as the model is over-specified. The next section collapses these 36 allele pairs into the 8 alleles.

## Genome Scan Using 8 Alleles

Calculate 8 allele probabilities from genotype probabilities.

```{r}
apr <- qtl2::genoprob_to_alleleprob(pr)
```

```{r}
str(apr)
```

```{r}
scan_apr <- qtl2::scan1(apr, DOex$pheno)
```

```{r}
qtl2::find_peaks(scan_apr, DOex$pmap)
```


```{r}
summary(scan_apr, DOex$pmap)
```

```{r}
plot(scan_apr, DOex$pmap, lodcolumn = "OF_immobile_pct")
title("Genome allele scan of OF_immobile_pct")
```

```{r}
scan_apr <- qtl2::scan1(apr, DOex$pheno)
```

```{r}
qtl2::find_peaks(scan_apr, DOex$pmap)
```

```{r}
summary(scan_apr, DOex$pmap)
```

```{r}
coefs <- qtl2::scan1coef(apr, DOex$pheno[,"OF_immobile_pct"], zerosum = FALSE)
```

```{r}
summary(coefs, scan_apr, DOex$pmap)
```

```{r}
plot(coefs, DOex$pmap, LETTERS[1:8],
     col = qtl2::CCcolors)
title("Allele Coefficients for OF_immobile_pct")
legend(0, 80, legend = names(qtl2::CCcolors), 
       col = qtl2::CCcolors, lty = 1, lwd = 2)
```

This gives a clearer picture, but it loses information in the allele pairs tied to SNP patterns. 


## SNP Association Mapping near Peak

This section examines SNP association mapping,
which involves collapsing the 36 allele pair genotype probabilities to
3 allele probabilities in the region of a QTL peak.

Download snp info from web and read as RDS.

```{r}
filename <- file.path("https://raw.githubusercontent.com/rqtl",
                      "qtl2data/master/DOex", 
                      "c2_snpinfo.rds")
tmpfile <- tempfile()
download.file(filename, tmpfile, quiet=TRUE)
snpinfo <- readRDS(tmpfile)
unlink(tmpfile)
```

Rename the SNP position as `pos`,
and add SNP index information.

```{r}
snpinfo <- dplyr::rename(snpinfo, pos = pos_Mbp)
snpinfo <- qtl2::index_snps(DOex$pmap, snpinfo)
```

Convert to SNP probabilities. Notice that starting with the allele probabilities only ends up with 2 SNP alleles per marker (`"A", "B"`), but we want all three (`"AA" "AB" "BB"`). Recall that the SNP alleles are in context of the strain distribution pattern (`sdp`) for that SNP.
The `sdp` for markers (`rsnnn`) are imputed in 'qtl2' from the adjacent SNPs.

```{r}
snpapr <- qtl2::genoprob_to_snpprob(apr, snpinfo)
str(snpapr)
```

```{r}
snppr <- qtl2::genoprob_to_snpprob(pr, snpinfo)
str(snppr)
```

```{r}
rm(snpapr)
```

Perform SNP association analysis (here, ignoring residual kinship).
The summary includes a range (`min` and `max`) for both `lod` and `pos`, as there could be multiple SNPs at the same position with different `sdp`s.

```{r}
scan_snppr <- qtl2::scan1(snppr, DOex$pheno)
```

```{r}
summary(scan_snppr, DOex$pmap, snpinfo)
```

Here is a plot with the SNPs used in the map only, highlighting those
within 1.5 LOD of the maximum, which are in the table above.


```{r}
plot(scan_snppr, snpinfo, lodcolumn = "OF_immobile_pct",
     drop_hilit = 1.5, show_all_snps = FALSE, cex = 1)
title("Peak Region SNP Scan of OF_immobile_pct")
```

Showing all the SNPs in the SNP information database is also possible,
which highlights more potential significant hits.

```{r}
plot(scan_snppr, snpinfo, lodcolumn = "OF_immobile_pct",
     drop_hilit = 1.5, show_all_snps = TRUE, cex = 1)
title("Peak Region SNP Scan of OF_immobile_pct")
```

## Strain Distribution Pattern (SDP) Scan

SNP assocation mapping would be more useful with plots that emphasized the strain distribution pattern (SDP) scan.
These separate out SNPs based on their SDP and plot the top patterns.
For instance `sdp = 52` corresponds to pattern `ABDGH:CEF`. That is, the SNP genotype `"AA"` resulting from `qtl2::genoprob_to_snpprob` applied to `pr` corresponds to any of the 36 allele pairs with the two alleles drawn from the set of `ABDGH` (15 pairs: `AA, AB, AD, AG, AH, BB, BD, BG, BH, DD, DG, DH, GG, GH, HH`), `"BB"` has two alleles from `CEF` (6 pairs: `CC, CE, CF, EE, EF, FF`), and `"AB"` has one from each (15 pairs: `AC, AE, ..., HF`).
There are 255 possible `sdp`s, but only a few (4 in our example) that need be examined carefully. One can think of these as a subset of markers for
genome scan, where interest is only in those SNPS following a particular `sdp`; as with genome scans, we can fill in for missing data.
That is, only a few SNPs may show a particular pattern, but key differences might be seen nearby if we impute SNPs of the same pattern.
The `top_snps_all` routine is an extension of `qtl2::top_snps`.

```{r}
top_snps_tbl <- top_snps_all(scan_snppr, snpinfo)
```

This first summary finds the range of SNP positions with the maximum LOD for the top SDPs.

```{r}
(patterns <- summary(top_snps_tbl))
```

If there is a range for the peak position, and multiple SNPs identified for an SDP,
it is worth looking at all SNPS to find what other ones might be best.
The earlier SNP association plot  suggested two locations about 0.01cM apart.
This summary shows the 3 SNPS with that SDP:

```{r}
head(summary(top_snps_tbl, "best"))
```
A new routine `scan_pattern` scans the peak region for each of the 4 patterns provided.

```{r}
scan_pat <- scan_pattern(pr, DOex$pheno,
                         map = DOex$pmap,
                         patterns = patterns)
```

```{r}
summary(scan_pat, DOex$pmap)
```

Here is a scan only in the region where we have SNPs.

```{r}
plot(scan_pat$scan, DOex$pmap, lodcolumn = 2, col = "red", xlim = c(90,110), type = "b")
abline(v = c(96.5, 98.5), col = "darkgray", lwd = 2, lty = 2)
plot(scan_pat$scan, DOex$pmap, lodcolumn = 1, add = TRUE, col = "blue", type = "b")
plot(scan_pat$scan, DOex$pmap, lodcolumn = 3, add = TRUE, col = "purple", type = "b")
plot(scan_pat$scan, DOex$pmap, lodcolumn = 4, add = TRUE, col = "green", type = "b")
title("Scans for SDP 52 (blue), 43 (red), 16 (purple), 20 (green)")
```

Here is a scan over the whole chromosome, imputing SDP.

```{r}
plot(scan_pat$scan, DOex$pmap, lodcolumn = 2, col = "red")
plot(scan_pat$scan, DOex$pmap, lodcolumn = 1, add = TRUE, col = "blue")
plot(scan_pat$scan, DOex$pmap, lodcolumn = 3, add = TRUE, col = "purple")
plot(scan_pat$scan, DOex$pmap, lodcolumn = 4, add = TRUE, col = "green")
title("Scans for SDP 52 (blue), 43 (red), 16 (purple), 20 (green)")
```

```{r}
knitr::knit_exit()
```

Modify plot_scan_pattern to facet on multiple phenotypes.

** There seems to be some problem with scan_pattern for plotting.

```{r eval=FALSE}
plot(scan_pat, DOex$pmap, patterns = patterns)
abline(v = c(96.5,98.5))
```

```{r eval = FALSE}
plot(scan_pat, DOex$pmap, "coef", ylim=c(-100,100))
abline(v = c(96.5,98.5))
```

```{r}
ggplot2::autoplot(scan_pat, DOex$pmap, "coef", ylim=c(-100,100)) +
  ggplot2::geom_vline(xintercept = c(96.5,98.5))
```

```{r}
ggplot2::autoplot(scan_pat, DOex$pmap, "coef_and_lod", ylim=c(-100,100))
```

Here we show the traditional QTL effects and LOD scan next to the newer scan pattern effects and LOD scans for comparison. The traditional LOD has 7 model degrees of freedom (df), while the scan pattern contrast LODs each have 2 model df. The LOD curves drop off somewhat more steeply for the scan pattern contrasts, and the peak is almost as high (`r round(max(scan_pat$scan, DOex$pmap)[,3], 1)` vs. `r round(max(scan_apr, DOex$pmap)[,3], 1)`).

The traditional QTL effects compare 8 founder additive allele effects,
while each scan pattern contrast compares the 3 SNP alleles,
reference (`ref` = `dark green`),
heterozygote (`het` = `dark orange`) and
alternate (`alt` = `dark blue`).
The scan pattern contrasts appear at first to be confusing and contradictory, with the `ABCDGH:EF` contrast showing that the `ref` allele is dominant (with `het` at the same level), while the `ABCDFGH:E` suggests `ref` is recessive. However, a closer look shows the following story with regard to the `alt` allele:

* the `ABCDFGH:E` contrast finds 1 or 2 `E=NZO` alleles have lower response
* the `ABCDGH:EF` contrast finds having only `E=NZO` and/or `F=CAST` alleles leads to lower response

These findings are thus complementary, and they agree with the traditional QTL effects plot showing `NZO` = `powder blue` and `CAST` = `green` alleles being much lower than the other 6 alleles.

```{r}
ggplot2::autoplot(coefs, DOex$pmap, scan1_output = scan_apr)
```

```{r}
ggplot2::autoplot(scan_pat, DOex$pmap, "coef_and_lod", ylim = c(-100,100))
```
